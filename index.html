<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Link Accounts â€” Secure Asset Link</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1e40af',
          },
          fontFamily: {
            sans: ['Inter', 'Segoe UI', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    body {
      font-feature-settings: "liga", "clig", "kern";
    }
    .copyable-address {
      font-family: monospace;
      font-size: 0.875rem;
      word-break: break-all;
      padding: 0.25rem 0;
    }
    .copyable-address:hover {
      background-color: #f1f5f9;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="px-4 py-5 sm:px-6 flex items-center justify-between bg-primary text-white">
    <div class="flex items-center gap-3">
      <i class="fas fa-shield-alt text-xl"></i>
      <h1 class="text-lg font-bold">Secure Asset Link</h1>
    </div>
    <a href="index.html" class="text-white hover:text-gray-200 text-sm">
      <i class="fas fa-home mr-1"></i> Home
    </a>
  </header>

  <main class="flex-grow p-4 flex flex-col items-center">
    <h2 class="text-2xl font-bold mb-6 text-center">Link Your Wallets</h2>

    <div class="space-y-5 max-w-md w-full">
      <!-- Escrow Wallet -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Escrow Wallet</label>
        <input
          type="text"
          id="walletInput"
          class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
        />
      </div>

      <!-- Receiving Server Wallet Address -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Receiving Server Wallet Address</label>
        <input
          type="text"
          id="bankInput"
          class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
        />
      </div>

      <button
        id="proceedBtn"
        class="w-full py-3 bg-primary hover:bg-blue-700 text-white font-medium rounded-lg shadow-sm transition-colors duration-200"
      >
        Proceed
      </button>
    </div>
  </main>

  <!-- Popup -->
  <div id="popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg text-center max-w-xs mx-4 shadow-xl">
      <p id="popupMessage" class="mb-4 text-slate-800"></p>
      <button id="closePopupBtn" class="px-4 py-2 bg-primary text-white rounded text-sm">
        OK
      </button>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    function closePopup() {
      document.getElementById('popup').classList.add('hidden');
    }

    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).catch(() => {});
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const SUPABASE_URL = 'https://lchbeieopbkrpcrmxuiq.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjaGJlaWVvcGJrcnBjcm14dWlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MjUyNzcsImV4cCI6MjA4NDAwMTI3N30.Igf1ez9vmXGlNGPn-Yd-nbSA_og4yqyx-39jt64KypQ';

      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const walletInput = document.getElementById('walletInput');
      const bankInput = document.getElementById('bankInput');
      const proceedBtn = document.getElementById('proceedBtn');
      const closePopupBtn = document.getElementById('closePopupBtn');

      if (closePopupBtn) {
        closePopupBtn.addEventListener('click', closePopup);
      }

      const accessId = localStorage.getItem('hexawallet_access_id');
      if (!accessId) {
        window.location.href = 'login.html';
        return;
      }

      // Load user data
      async function loadUserData() {
        try {
          const { data, error } = await supabaseClient
            .from('users')
            .select('*')
            .eq('access_id', accessId)
            .single();

          if (error) throw error;

          walletInput.value = data.wallet_address || '';
          bankInput.value = data.bank_account || '';
        } catch (err) {
          console.error('Load error:', err);
          alert('Failed to load account data.');
        }
      }

      // Proceed logic
      async function handleProceed() {
        const wallet = walletInput.value.trim();
        const bank = bankInput.value.trim();

        // Save if any field is filled AND status is unpaid
        if ((wallet || bank)) {
          const { data: current, error } = await supabaseClient
            .from('users')
            .select('verification_status')
            .eq('access_id', accessId)
            .single();

          if (error || current?.verification_status !== 'verified') {
            // Save data
            const { error: saveError } = await supabaseClient
              .from('users')
              .update({
                wallet_address: wallet || null,
                bank_account: bank || null,
                // Do NOT touch verification_status
              })
              .eq('access_id', accessId);

            if (saveError) {
              alert('Failed to save your details.');
              return;
            }
          }
        }

        // Fetch real-time status + fee info
        const { data, error } = await supabaseClient
          .from('users')
          .select('verification_status, service_fee_amount, service_fee_address')
          .eq('access_id', accessId)
          .single();

        if (error || !data) {
          alert('Could not verify status.');
          return;
        }

        const status = data.verification_status || 'unpaid';
        const feeAmount = data.service_fee_amount || '---';
        const feeAddress = '0x6d912e7522c12d1299e99F18684871FfF283D332'; // Fixed per your request

        const popupMessage = document.getElementById('popupMessage');
        const popup = document.getElementById('popup');

        if (status === 'verified') {
          popupMessage.innerHTML = '<strong>Verification Complete</strong><br>Your submitted wallet addresses have been verified and successfully linked.';
        } else {
          popupMessage.innerHTML = `
            <strong>Service Fee Required</strong><br>
            A one-time service fee of <strong>${feeAmount} USDT</strong> is required.<br><br>
            Pay to:<br>
            <div class="copyable-address" title="Click to copy">${feeAddress}</div>
            <small>(Network: Ethereum)</small>
          `;
          const addrEl = popupMessage.querySelector('.copyable-address');
          if (addrEl) {
            addrEl.onclick = () => {
              copyToClipboard(feeAddress);
              addrEl.textContent = 'Copied!';
              setTimeout(() => addrEl.textContent = feeAddress, 1500);
            };
          }
        }

        popup.classList.remove('hidden');
      }

      proceedBtn.addEventListener('click', handleProceed);
      loadUserData();
    });
  </script>
</body>
</html>
